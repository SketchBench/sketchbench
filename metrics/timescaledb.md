# Metrics from TimescaleDB

## Spark Streaming App

### Stages

```sql
SELECT TIME,
	VALUE AS COMPLETED_STAGES
FROM PROM_METRIC.SPARK_APP_STATUS
WHERE VAL(QTY_ID) LIKE 'completedStages'
	AND TIME BETWEEN '2021-08-02 04:15:00'::TIMESTAMP AND '2021-08-02 06:35:00'::TIMESTAMP
ORDER BY TIME ASC
```

```sql
SELECT TIME,
	VALUE AS FAILED_STAGES
FROM PROM_METRIC.SPARK_APP_STATUS
WHERE VAL(QTY_ID) LIKE 'failedStages'
	AND TIME BETWEEN '2021-08-02 04:15:00'::TIMESTAMP AND '2021-08-02 06:35:00'::TIMESTAMP
ORDER BY TIME ASC
```

```sql
SELECT TIME,
	VALUE AS SKIPPED_STAGES
FROM PROM_METRIC.SPARK_APP_STATUS
WHERE VAL(QTY_ID) LIKE 'skippedStages'
	AND TIME BETWEEN '2021-08-02 04:15:00'::TIMESTAMP AND '2021-08-02 06:35:00'::TIMESTAMP
ORDER BY TIME ASC
```

### Tasks

```sql
SELECT TIME,
	VALUE AS COMPLETED_TASKS
FROM PROM_METRIC.SPARK_APP_STATUS
WHERE VAL(QTY_ID) LIKE 'completedTasks'
	AND TIME BETWEEN '2021-08-02 04:15:00'::TIMESTAMP AND '2021-08-02 06:35:00'::TIMESTAMP
ORDER BY TIME ASC
```

```sql
SELECT TIME,
	VALUE AS FAILED_TASKS
FROM PROM_METRIC.SPARK_APP_STATUS
WHERE VAL(QTY_ID) LIKE 'failedTasks'
	AND TIME BETWEEN '2021-08-02 04:15:00'::TIMESTAMP AND '2021-08-02 06:35:00'::TIMESTAMP
ORDER BY TIME ASC
```

```sql
SELECT TIME,
	VALUE AS SKIPPED_TASKS
FROM PROM_METRIC.SPARK_APP_STATUS
WHERE VAL(QTY_ID) LIKE 'skippedTasks'
	AND TIME BETWEEN '2021-08-02 04:15:00'::TIMESTAMP AND '2021-08-02 06:35:00'::TIMESTAMP
ORDER BY TIME ASC
```

### Block Manager

```sql
SELECT TIME,
	VALUE AS MEM_USED_MB
FROM PROM_METRIC.SPARK_BLOCK_MANAGER
WHERE VAL(QTY_ID) LIKE 'memUsed_MB'
	AND TIME BETWEEN '2021-08-02 04:15:00'::TIMESTAMP AND '2021-08-02 06:35:00'::TIMESTAMP
ORDER BY TIME ASC
```

```sql
SELECT TIME,
	VALUE AS OFF_HEAP_MEM_USED_MB
FROM PROM_METRIC.SPARK_BLOCK_MANAGER
WHERE VAL(QTY_ID) LIKE 'offHeapMemUsed_MB'
	AND TIME BETWEEN '2021-08-02 04:15:00'::TIMESTAMP AND '2021-08-02 06:35:00'::TIMESTAMP
ORDER BY TIME ASC
```

```sql
SELECT TIME,
	VALUE AS ON_HEAP_MEM_USED_MB
FROM PROM_METRIC.SPARK_BLOCK_MANAGER
WHERE VAL(QTY_ID) LIKE 'onHeapMemUsed_MB'
	AND TIME BETWEEN '2021-08-02 04:15:00'::TIMESTAMP AND '2021-08-02 06:35:00'::TIMESTAMP
ORDER BY TIME ASC
```

### Jobs

```sql
SELECT TIME,
	VALUE AS SUCCEEDED_JOBS
FROM PROM_METRIC.SPARK_APP_STATUS
WHERE VAL(QTY_ID) LIKE 'succeededJobs'
	AND TIME BETWEEN '2021-08-02 04:15:00'::TIMESTAMP AND '2021-08-02 06:35:00'::TIMESTAMP
ORDER BY TIME ASC
```

```sql
SELECT TIME,
	VALUE AS FAILED_JOBS
FROM PROM_METRIC.SPARK_APP_STATUS
WHERE VAL(QTY_ID) LIKE 'failedJobs'
	AND TIME BETWEEN '2021-08-02 04:15:00'::TIMESTAMP AND '2021-08-02 06:35:00'::TIMESTAMP
ORDER BY TIME ASC
```

### Processing Time

```sql
SELECT START_VIEW.TIME AS TIME,
	END_TIME - START_TIME AS PROCESSING_TIME
FROM
	(SELECT TIME,
			VALUE AS START_TIME
		FROM PROM_METRIC.SPARK_STREAMING_APP
		WHERE VAL(QTY_ID) LIKE 'lastCompletedBatch_processingStartTime'
			AND TIME BETWEEN '2021-08-02 04:15:00'::TIMESTAMP AND '2021-08-02 06:35:00'::TIMESTAMP ) START_VIEW
JOIN
	(SELECT TIME,
			VALUE AS END_TIME
		FROM PROM_METRIC.SPARK_STREAMING_APP
		WHERE VAL(QTY_ID) LIKE 'lastCompletedBatch_processingEndTime'
			AND TIME BETWEEN '2021-08-02 04:15:00'::TIMESTAMP AND '2021-08-02 06:35:00'::TIMESTAMP ) END_VIEW ON START_VIEW.TIME = END_VIEW.TIME
ORDER BY TIME ASC
```

### Delays

```sql
SELECT TIME,
	VALUE AS PROCESSING_DELAY
FROM PROM_METRIC.SPARK_STREAMING_APP
WHERE VAL(QTY_ID) LIKE 'lastCompletedBatch_processingDelay'
	AND TIME BETWEEN '2021-08-02 04:15:00'::TIMESTAMP AND '2021-08-02 06:35:00'::TIMESTAMP
ORDER BY TIME ASC
```

```sql
SELECT TIME,
	VALUE AS SCHEDULING_DELAY
FROM PROM_METRIC.SPARK_STREAMING_APP
WHERE VAL(QTY_ID) LIKE 'lastCompletedBatch_schedulingDelay'
	AND TIME BETWEEN '2021-08-02 04:15:00'::TIMESTAMP AND '2021-08-02 06:35:00'::TIMESTAMP
ORDER BY TIME ASC
```

### Messaging Records

```sql
SELECT TIME,
	VALUE AS TOTAL_PROCESSED_RECORDS
FROM PROM_METRIC.SPARK_STREAMING_APP
WHERE VAL(QTY_ID) LIKE 'totalProcessedRecords'
	AND TIME BETWEEN '2021-08-02 04:15:00'::TIMESTAMP AND '2021-08-02 06:35:00'::TIMESTAMP
ORDER BY TIME ASC
```

```sql
SELECT TIME,
	VALUE AS TOTAL_RECEIVED_RECORDS
FROM PROM_METRIC.SPARK_STREAMING_APP
WHERE VAL(QTY_ID) LIKE 'totalReceivedRecords'
	AND TIME BETWEEN '2021-08-02 04:15:00'::TIMESTAMP AND '2021-08-02 06:35:00'::TIMESTAMP
ORDER BY TIME ASC
```

```sql
SELECT TIME,
	VALUE / 2 AS LAST_BATCH_RECORDS_PER_SEC
FROM PROM_METRIC.SPARK_STREAMING_APP
WHERE VAL(QTY_ID) LIKE 'lastReceivedBatch_records'
	AND TIME BETWEEN '2021-08-02 04:15:00'::TIMESTAMP AND '2021-08-02 06:35:00'::TIMESTAMP
ORDER BY TIME ASC
```

## Spark

### CPU Usage

#### Workers CPU Usage

```sql
SELECT TIME,
	VALUE AS CPU_USAGE_SECONDS_TOTAL,
	VAL(POD_ID) AS POD
FROM PROM_METRIC.CONTAINER_CPU_USAGE_SECONDS_TOTAL
WHERE VAL(POD_ID) LIKE '%spark-worker%'
	AND VAL(CONTAINER_ID) = 'spark-worker'
	AND TIME BETWEEN '2021-08-02 04:15:00'::TIMESTAMP AND '2021-08-02 06:35:00'::TIMESTAMP
ORDER BY TIME ASC
```

#### Driver CPU Usage

```sql
SELECT TIME,
	VALUE AS CPU_USAGE_SECONDS_TOTAL,
	VAL(POD_ID) AS POD
FROM PROM_METRIC.CONTAINER_CPU_USAGE_SECONDS_TOTAL
WHERE VAL(POD_ID) LIKE '%spark-backend%'
	AND VAL(CONTAINER_ID) = 'spark-backend'
	AND TIME BETWEEN '2021-08-02 04:15:00'::TIMESTAMP AND '2021-08-02 06:35:00'::TIMESTAMP
ORDER BY TIME ASC
```

### Memory Usage

#### Workers Memory in Bytes

```sql
SELECT TIME,
	VALUE AS VALUE_MEM_BYTES,
	VAL(POD_ID) AS POD
FROM PROM_METRIC.CONTAINER_MEMORY_WORKING_SET_BYTES
WHERE VAL(POD_ID) LIKE '%spark-worker%'
	AND CONTAINER_ID > 0
	AND TIME BETWEEN '2021-08-02 04:15:00'::TIMESTAMP AND '2021-08-02 06:35:00'::TIMESTAMP
ORDER BY TIME ASC
```

#### Driver Memory in Bytes

```sql
SELECT TIME,
	VALUE AS VALUE_MEM_BYTES,
	VAL(POD_ID) AS POD
FROM PROM_METRIC.CONTAINER_MEMORY_WORKING_SET_BYTES
WHERE VAL(POD_ID) LIKE '%spark-backend%'
	AND VAL(CONTAINER_ID) = 'spark-backend'
	AND TIME BETWEEN '2021-08-02 04:15:00'::TIMESTAMP AND '2021-08-02 06:35:00'::TIMESTAMP
ORDER BY TIME ASC
```

### RDD Blocks

```sql
SELECT TIME,
	VALUE AS RDD_BLOCKS,
	VAL(EXECUTOR_ID_ID) AS EXECUTOR
FROM PROM_METRIC."metrics_executor_rddBlocks"
WHERE VAL(EXECUTOR_ID_ID) <> 'driver'
	AND TIME BETWEEN '2021-08-02 04:15:00'::TIMESTAMP AND '2021-08-02 06:35:00'::TIMESTAMP
ORDER BY TIME ASC
```

#### Completed Tasks

```sql
SELECT TIME,
	VALUE AS COMPLETED_TASKS,
	VAL(EXECUTOR_ID_ID) AS EXECUTOR
FROM PROM_METRIC."metrics_executor_completedTasks_total"
WHERE VAL(EXECUTOR_ID_ID) <> 'driver'
	AND TIME BETWEEN '2021-08-02 04:15:00'::TIMESTAMP AND '2021-08-02 06:35:00'::TIMESTAMP
ORDER BY TIME ASC
```

#### Active Tasks

```sql
SELECT TIME,
	VALUE AS ACTIVE_TASKS,
	VAL(EXECUTOR_ID_ID) AS EXECUTOR
FROM PROM_METRIC."metrics_executor_activeTasks"
WHERE VAL(EXECUTOR_ID_ID) <> 'driver'
	AND TIME BETWEEN '2021-08-02 04:15:00'::TIMESTAMP AND '2021-08-02 06:35:00'::TIMESTAMP
ORDER BY TIME ASC
```

#### Memory Used

```sql
SELECT TIME,
	VALUE AS MEMORY_USED_BYTES,
	VAL(EXECUTOR_ID_ID) AS EXECUTOR
FROM PROM_METRIC."metrics_executor_memoryUsed_bytes"
WHERE VAL(EXECUTOR_ID_ID) <> 'driver'
	AND TIME BETWEEN '2021-08-02 04:15:00'::TIMESTAMP AND '2021-08-02 06:35:00'::TIMESTAMP
ORDER BY TIME ASC
```

#### Shuffle Write

```sql
SELECT TIME,
	VALUE AS SHUFFLE_WRITE_BYTES_TOTAL,
	VAL(EXECUTOR_ID_ID) AS EXECUTOR
FROM PROM_METRIC."metrics_executor_totalShuffleWrite_bytes_total"
WHERE VAL(EXECUTOR_ID_ID) <> 'driver'
	AND TIME BETWEEN '2021-08-02 04:15:00'::TIMESTAMP AND '2021-08-02 06:35:00'::TIMESTAMP
ORDER BY TIME ASC
```

#### Shuffle Read

```sql
SELECT TIME,
	VALUE AS SHUFFLE_READ_BYTES_TOTAL,
	VAL(EXECUTOR_ID_ID) AS EXECUTOR
FROM PROM_METRIC."metrics_executor_totalShuffleRead_bytes_total"
WHERE VAL(EXECUTOR_ID_ID) <> 'driver'
	AND TIME BETWEEN '2021-08-02 04:15:00'::TIMESTAMP AND '2021-08-02 06:35:00'::TIMESTAMP
ORDER BY TIME ASC
```

## Kafka

### Network

#### Bytes In per sec (One Minute Rate)

```sql
SELECT TIME,
	VALUE AS BYTESINPERSEC_ONEMINUTERATE
FROM PROM_METRIC.KAFKA_SERVER_BROKERTOPICMETRICS_BYTESINPERSEC_ONEMINUTERATE
WHERE VAL(TOPIC_ID) = 'SketchBench-1-1'
	AND VAL(JOB_ID) = 'sketchbench-kafka-jmx-metrics'
	AND TIME BETWEEN '2021-08-02 04:15:00'::TIMESTAMP AND '2021-08-02 06:35:00'::TIMESTAMP
ORDER BY TIME ASC
```

#### Bytes Out per sec (One Minute Rate)

```sql
SELECT TIME,
	VALUE AS BYTESOUTPERSEC_ONEMINUTERATE
FROM PROM_METRIC.KAFKA_SERVER_BROKERTOPICMETRICS_BYTESOUTPERSEC_ONEMINUTERATE
WHERE VAL(TOPIC_ID) = 'SketchBench-1-1'
	AND VAL(JOB_ID) = 'sketchbench-kafka-jmx-metrics'
	AND TIME BETWEEN '2021-08-02 04:15:00'::TIMESTAMP AND '2021-08-02 06:35:00'::TIMESTAMP
ORDER BY TIME ASC
```

### Requests

#### Requests In per /sec (One Minute Rate)

```sql
SELECT TIME,
	VALUE AS REQUESTS_PER_SEC_IN
FROM PROM_METRIC.KAFKA_SERVER_BROKERTOPICMETRICS_TOTALPRODUCEREQUESTSPERSE_1618
WHERE VAL(TOPIC_ID) = 'SketchBench-1-1'
	AND VAL(JOB_ID) = 'sketchbench-kafka-jmx-metrics'
	AND TIME BETWEEN '2021-08-02 04:15:00'::TIMESTAMP AND '2021-08-02 06:35:00'::TIMESTAMP
ORDER BY TIME ASC
```

#### Requests Out per sec (One Minute Rate)

```sql
SELECT TIME,
	VALUE AS REQUESTS_PER_SEC_OUT
FROM PROM_METRIC.KAFKA_SERVER_BROKERTOPICMETRICS_TOTALFETCHREQUESTSPERSEC__1626
WHERE VAL(TOPIC_ID) = 'SketchBench-1-1'
	AND VAL(JOB_ID) = 'sketchbench-kafka-jmx-metrics'
	AND TIME BETWEEN '2021-08-02 04:15:00'::TIMESTAMP AND '2021-08-02 06:35:00'::TIMESTAMP
ORDER BY TIME ASC
```

### Offset

#### Current Consumer Offset by Consumer Group

```sql
SELECT TIME,
	VALUE AS CURRENT_CONSUMER_OFFSET,
	VAL(CONSUMERGROUP_ID) AS CONSUMERGROUP,
	VAL(PARTITION_ID) AS KAFKA_PARTITION
FROM PROM_METRIC.KAFKA_CONSUMERGROUP_CURRENT_OFFSET
WHERE VAL(TOPIC_ID) = 'SketchBench-1-1'
	AND VAL(JOB_ID) = 'sketchbench-kafka-metrics'
	AND TIME BETWEEN '2021-08-02 04:15:00'::TIMESTAMP AND '2021-08-02 06:35:00'::TIMESTAMP
ORDER BY TIME ASC
```

#### Current Producer Offset by Consumer Group

```sql
SELECT TIME,
	VALUE AS CURRENT_CONSUMER_OFFSET,
	VAL(PARTITION_ID) AS KAFKA_PARTITION
FROM PROM_METRIC.KAFKA_TOPIC_PARTITION_CURRENT_OFFSET
WHERE VAL(TOPIC_ID) = 'SketchBench-1-1'
	AND VAL(JOB_ID) = 'sketchbench-kafka-metrics'
	AND TIME BETWEEN '2021-08-02 04:15:00'::TIMESTAMP AND '2021-08-02 06:35:00'::TIMESTAMP
ORDER BY TIME ASC
```
